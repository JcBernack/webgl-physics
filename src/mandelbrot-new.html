<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mandelbrot</title>
    <style type="text/css">
        body {
            margin: 0;
            overflow: hidden;
            color: white;
        }

        canvas {
            cursor: pointer;
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<script src="lib/dat.gui.min.js"></script>

<script>

    /**
     * Mandelbrot renderer with arbitrary precision and interlaced parallel updates
     * arbitrary precision library:
     * parallelization using WebWorkers: http://www.w3schools.com/html/html5_webworkers.asp
     */
    function Mandelbrot() {

        this.canvas = null;
        this.center = { re: -0.739795, im: 0.288266 };
        this.zoom = 0.000013;

        var ctx = null;
        var workers = [];
        var renderStart = 0;

        this.initWorkers = function(count) {
            var i;
            for (i = 0; i < workers.length; i++) {
                workers[i].terminate();
            }
            for (i = 0; i < count; i++) {
                var worker = new Worker("mandelbrot-worker.js");
                worker.addEventListener("message", this.message);
                workers.push(worker);
            }
        };

        this.message = function(e) {
            var elapsed = performance.now() - renderStart;
            console.log("received after", elapsed, e);
            var d = e.data;
            var image = ctx.createImageData(d.width, d.height);
            var k = 0;
            for (var i = 0; i < d.result.length; i++) {
                var c = d.result[i] / d.iterations * 255;
                //TODO: add fancy color mapping
                image.data[k++] = c;
                image.data[k++] = c;
                image.data[k++] = c;
                image.data[k++] = 255;
            }
            ctx.putImageData(image, d.x, d.y);
        };

        this.render = function() {
            console.log("rendering");
            renderStart = performance.now();
            var grid = 16;
            var d = {
                // pixel rectangle in the image
                x: 0,
                y: 0,
                width: Math.floor(this.canvas.width / grid),
                height: Math.floor(this.canvas.height / grid),
                // rectangle in the complex plane
                re_start: 0,
                im_start: 0,
                re_range: this.zoom / grid,
                im_range: this.zoom / grid * this.canvas.height / this.canvas.width,
                // constants
                iterations: 200
            };
            var re_start = this.center.re - d.re_range * grid / 2;
            var im_start = -this.center.im - d.im_range * grid / 2;
            var w = 0;
            for (var x = 0; x < grid; x++) {
                for (var y = 0; y < grid; y++) {
                    d.x = d.width * x;
                    d.y = d.height * y;
                    d.re_start = re_start + d.re_range * x;
                    d.im_start = im_start + d.im_range * y;
                    ctx.beginPath();
                    ctx.rect(d.x, d.y, d.width, d.height);
                    ctx.stroke();
                    //TODO: wait till a worker has finishes its previous block before posting a new one
                    //TODO: cancel render on resize etc.
                    //TODO: maybe don't use blocks, but use an interlaced update scheme
                    workers[w++].postMessage(d);
                    if (w == workers.length) w = 0;
                }
            }
        };

        this.init = function(canvas, workerCount) {
            ctx = canvas.getContext("2d");
            this.canvas = canvas;
            this.initWorkers(workerCount);
        };
    }

    var canvas = document.getElementById("canvas");
    var mandel = new Mandelbrot();
    mandel.init(canvas, 8);
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        mandel.render();
    }
    window.addEventListener("resize", resize);
    resize();
</script>

</body>
</html>
